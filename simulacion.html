<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Simulación</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    </head>
    <body class="container d-flex m-4">
        <div class="card col-8" >
            <div class="card-body" id="grafica">
                <h5 class="card-title">Grafica</h5>
                <canvas id="graph"></canvas>
            </div>
        </div>
        <div class="card col-5" >
        <div class="card-body">
            <h5 class="card-title">Modificadores</h5>
            <form>
                <label for="button" class="form-label d-none">Tipo entrada</label>
                <div class="input-group mb-3 d-none">
                    <div class="input-group-text">
                        <input class="form-check-input mt-0" type="radio" name="radioTipoEntrada" value="0" aria-label="radio for following text input">
                        <label class="form-check-label ms-2 me-2">Impulso</label>
                        <input class="form-check-input mt-0" type="radio" name="radioTipoEntrada" value="1" aria-label="radio for following text input" checked>
                        <label class="form-check-label ms-2 me-2">Escalon</label>
                        <input class="form-check-input mt-0" type="radio" name="radioTipoEntrada" value="2" aria-label="radio for following text input">
                        <label class="form-check-label ms-2 me-2">Rampa</label>
                    </div>
                </div>
                <div>
                    <label for="customRange1" class="form-label">Amplitud entrada</label>
                    <output for="customRange1" id="rangeValue" aria-hidden="true"></output>
                    <input type="range" class="form-range" id="customRange1" min="0" max="100" step="1">       
                </div>
                <label for="button" class="form-label">Perturbación</label>
                <div>
                    <label for="ampPerturbacion" class="form-label">Amplitud Perturbación</label>
                    <output for="ampPerturbacion" id="outPerturbacion" aria-hidden="true"></output>
                    <input type="range" class="form-range" id="ampPerturbacion" min="0" max="100" step="1">       
                </div>
                <div class="input-group mb-3">
                    <button type="button" id="perturbar" class="btn btn-outline-secondary">Perturbar</button>
                    <div class="input-group-text">
                        <input class="form-check-input mt-0" type="radio" name="radioTipoPertur" value="0" aria-label="radio for following text input" checked>
                        <label class="form-check-label ms-2 me-2">Impulso</label>
                        <input class="form-check-input mt-0 d-none" type="radio" name="radioTipoPertur" value="1" aria-label="radio for following text input">
                        <label class="form-check-label ms-2 d-none me-2">Escalon</label>
                    </div>
                </div>
                <div>
                    <label for="customRange2" class="form-label">Factor Proporcional</label>
                    <output for="customRange2" id="rangeValue2" aria-hidden="true"></output>
                    <input type="range" class="form-range" id="customRange2" min="0" max="100" step="1"> 
                </div>
                <div>
                    <label for="customRange3" class="form-label">Factor Integral</label>
                    <output for="customRange3" id="rangeValue3" aria-hidden="true"></output>
                    <input type="range" class="form-range" id="customRange3" min="0" max="100" step="1">  
                </div>
                <div>
                    <label for="customRange4" class="form-label">Factor Derivativo</label>
                    <output for="customRange4" id="rangeValue4" aria-hidden="true"></output>
                    <input type="range" class="form-range" id="customRange4" min="0" max="100" step="1">
                </div>
                <div>
                    <label for="customRange5" class="form-label">Factor Retroalimentación</label>
                    <output for="customRange5" id="rangeValue5" aria-hidden="true"></output>
                    <input type="range" class="form-range" id="customRange5" min="0" max="250" step="1">
                </div>
            </form>
        </div>
        </div>
        <script>
            // This is an example script, please modify as needed
            const ampEntrada = document.getElementById('customRange1');
            const outputEnt = document.getElementById('rangeValue');

            const fProporcional = document.getElementById('customRange2');
            const outputProp = document.getElementById('rangeValue2');

            const fIntegral = document.getElementById('customRange3');
            const outputInt = document.getElementById('rangeValue3');

            const fDerivativo = document.getElementById('customRange4');
            const outputDer = document.getElementById('rangeValue4');

            const fRetro = document.getElementById('customRange5');
            const outputRetro = document.getElementById('rangeValue5');

            const ampPer = document.getElementById('ampPerturbacion');
            const outPer = document.getElementById('outPerturbacion');


            // Set initial value
            ampEntrada.value = 63;
            outputEnt.textContent = ampEntrada.value;

            ampEntrada.addEventListener('input', function() {
                outputEnt.textContent = this.value;
            });

            fProporcional.value = 60;
            outputProp.textContent = fProporcional.value;

            fProporcional.addEventListener('input', function() {
                outputProp.textContent = this.value;
            });

            fIntegral.value = 100;
            outputInt.textContent = fIntegral.value;

            fIntegral.addEventListener('input', function() {
                outputInt.textContent = this.value;
            });

            fDerivativo.value = 50;
            outputDer.textContent = fDerivativo.value;

            fDerivativo.addEventListener('input', function() {
                outputDer.textContent = this.value;
            });

            fRetro.value = 40;
            outputRetro.textContent = fRetro.value;

            fRetro.addEventListener('input', function() {
                outputRetro.textContent = this.value;
            });

            ampPer.value = 10;
            outPer.textContent = ampPer.value;

            ampPer.addEventListener('input', function() {
                outPer.textContent = this.value;
            });

        </script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.0/chart.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
        <script>
            let cantValores = 25;
            const labels = Array.from({length: cantValores}, (_, i) => `T${i+1}`);

            let datasetEntrada = {
                    label: 'Entrda(θ_i)',
                    data: Array(cantValores).fill(0),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                };
            let datasetPerturbacion = {
                    label: 'Perturbación(P)',
                    data: Array(cantValores).fill(0),
                    backgroundColor: 'rgba(248, 37, 37, 0.2)',
                    borderColor: 'rgba(248, 37, 37, 1)',
                    borderWidth: 1
                };
            let datasetSalidaCon = {
                    label: 'SalidaControlador(h)',
                    data: Array(cantValores).fill(0),
                    backgroundColor: 'rgba(69, 248, 84, 0.2)',
                    borderColor: 'rgba(69, 248, 84, 1)',
                    borderWidth: 1
                };
            let datasetRetro = {
                    label: 'Retroalimentación(f)',
                    data: Array(cantValores).fill(0),
                    backgroundColor: 'rgba(245, 40, 145, 0.2)',
                    borderColor: 'rgba(245, 40, 145, 0.8)',
                    borderWidth: 1
                };
            let datasetError = {
                    label: 'Error(e)',
                    data: Array(cantValores).fill(0),
                    backgroundColor: 'rgba(235, 192, 52, 0.2)',
                    borderColor: 'rgba(235, 192, 52, 1)',
                    borderWidth: 1
                };
            let datasetSalida = {
                    label: 'Salida(θ_o)',
                    data: Array(cantValores).fill(0),
                    backgroundColor: 'rgba(110, 17, 250, 0.2)',
                    borderColor: 'rgba(110, 17, 250, 1)',
                    borderDash: [5, 5],
                    borderWidth: 1
                };

            const data = {
                labels: labels,
                datasets: [datasetEntrada, datasetRetro, datasetError, datasetSalidaCon, datasetSalida, datasetPerturbacion]
            };

            // Configuration options
            const config = {
                type: 'line',
                data: data,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            };

            // Render the chart
            const myChart = new Chart(
                document.getElementById('graph'),
                config
            );

            let acumuladoParaIntegral = 0;
            let ciclos = 0;

            let identificadorIntervaloDeTiempo;

            let perturbacion = 0;

            function repetirCadaSegundo() {
                identificadorIntervaloDeTiempo = setInterval(actualizarDatasets, 1000);
            }
            repetirCadaSegundo();

            let kp = fProporcional.value / 100;
            let ki = fIntegral.value / 100;
            let kd = fDerivativo.value / 100;

            function actualizarDatasets() {
                datasetEntrada.data.shift();
                datasetEntrada.data.push(parseFloat(ampEntrada.value));
                
                datasetError.data.shift();
                datasetError.data.push(ampEntrada.value - datasetRetro.data[datasetRetro.data.length - 1]);

                acumuladoParaIntegral += datasetError.data[datasetError.data.length - 1];
                ciclos++;

                datasetSalidaCon.data.shift();
                datasetSalidaCon.data.push(
                    datasetError.data[datasetError.data.length - 1] * kp +
                    (acumuladoParaIntegral/ciclos) * ki +
                    (datasetError.data[datasetError.data.length - 1] - datasetError.data[datasetError.data.length - 2]) * kd +
                    datasetPerturbacion.data[datasetPerturbacion.data.length - 1]
                );

                datasetRetro.data.shift();
                datasetRetro.data.push(datasetSalidaCon.data[datasetSalidaCon.data.length - 1]*fRetro.value/100);

                datasetSalida.data.shift();
                datasetSalida.data.push(valorRpm(datasetSalidaCon.data[datasetSalidaCon.data.length - 1]));
                
                datasetPerturbacion.data.shift();
                datasetPerturbacion.data.push(perturbacion);

                myChart.data = data;
                myChart.update();
            }

            function promedioArray(array){
                let suma = 0;
                for(let i = 0; i < array.length; i++){
                    suma += array[i];
                }
                return suma / array.length;
            }
            
            function valorRpm(temp){
                let valor = 6 + (54)/(100)*(temp-5);
                let real = Math.max(6, Math.min(60, valor));
                return real;
            }

            const botonPerturbar = document.getElementById('perturbar');

            botonPerturbar.addEventListener('click', function(){
                let tipoImpulso = document.getElementsByName('radioTipoPertur');
                let i = 0;
                while(i < tipoImpulso.length && !tipoImpulso[i].checked){
                    i++
                }
                let impPer = document.getElementById('ampPerturbacion');
                perturbacion = parseFloat(impPer.value);
                if(i == 0){
                    console.log("Perturbación tipo impulso");  
                    datasetPerturbacion.data.shift();
                    datasetPerturbacion.data.push(parseFloat(impPer.value));
                    perturbacion = 0;
                }else{
                    console.log("Perturbación tipo escalon");  
                    datasetPerturbacion.data.shift();
                    datasetPerturbacion.data.push(parseFloat(impPer.value));
                }
            })
        </script>
    </body>
</html>